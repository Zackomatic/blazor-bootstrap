@inherits BootstrapComponentBase

<CascadingValue Name="@TabContainerParameterName" Value="this">
@if(Tabs == null)
{
    <TabList>
        @foreach(var tabPanePair in _tabPanes)
        {
            var tabPane = tabPanePair.Value;
            <TabItem Active="tabPane.Active"
                     LinkClicked="async () => await SetActiveTabAsync(tabPane)">
                @tabPane.Title
            </TabItem>
        }
    </TabList>
}
@if(Panes != null)
{
    <TabContent>
        @Panes
    </TabContent>
}
</CascadingValue>

@code {
    public const string TabContainerParameterName = nameof(TabContainer);

    private Dictionary<string, TabPane> _tabPanes = new();
    private string _fadeInTabId;

    [Parameter]
    public RenderFragment Tabs { get; set; }

    [Parameter]
    public RenderFragment Content { get; set; }

    [Parameter]
    public RenderFragment Panes { get; set; }

    [Parameter]
    public bool Fade { get; set; }

    private string _activeTabId;
    [Parameter]
    public string ActiveTabId
    {
        get => _activeTabId;
        set
        {
            if (_activeTabId == value)
                return;

            if(!_tabPanes.Any())
            {
                _activeTabId = value;
                return;
            }

            if (!_tabPanes.ContainsKey(value))
                throw new InvalidOperationException($"Could not find {nameof(TabPane)} with Id {value}. Unable to update active tab.");

            UpdateActiveTab(value);
        }
    }

    [Parameter]
    public EventCallback<string> ActiveTabIdChanged { get; set; }

    TabPane ActiveTab => _tabPanes[ActiveTabId];

    public void RegisterTab(TabPane tabPane)
    {
        _tabPanes.Add(tabPane.Id, tabPane);

        if(string.IsNullOrWhiteSpace(ActiveTabId)
            || ActiveTabId == tabPane.Id)
        {
            _activeTabId = tabPane.Id;
            tabPane.Show();
        }
        StateHasChanged();
    }

    public IList<TabPane> GetTabs() => _tabPanes.Select(x => x.Value).ToList();

    public async Task SetActiveTabAsync(TabPane tabPane)
    {
        ActiveTabId = tabPane.Id;
        await ActiveTabIdChanged.InvokeAsync(ActiveTabId);
    }

    public async Task SetActiveTabAsync(string tabPaneId) =>
        await SetActiveTabAsync(_tabPanes[ActiveTabId]);

    internal void HideActiveTab()
    {
        if(!string.IsNullOrWhiteSpace(ActiveTabId))
        {
            ActiveTab.Hide();
        }
    }

    internal void FadeInActiveTab()
    {
        _activeTabId = _fadeInTabId;
        ActiveTab.Show();
        StateHasChanged();
    }

    void UpdateActiveTab(string activeTabId)
    {
        if(Fade)
        {
            _fadeInTabId = activeTabId;
            HideActiveTab();
        }
        else
        {
            HideActiveTab();
            _activeTabId = activeTabId;
            ActiveTab.Show();
        }
    }
}
