@inherits TestBase<TabContainer>

@code {
    const string TabId1 = "tab_one";
    const string TabId2 = "tab_two";
    const string TabId3 = "tab_three";
    const string Title1 = "Tab Title 1";
    const string Title2 = "Tab Title 2";
    const string Title3 = "Tab Title 3";

    public TabContainerTest()
    {
        // this is needed by the TabPane component
        new MockBootstrapJsService(Services);
    }

    [Fact]
    public void PanesIsSet_RendersTabContentWithPanesChildContent()
    {
        var cut = RenderComponent(
            @<TabContainer>
                <Panes>
                    <TabPane>Pane 1</TabPane>
                    <TabPane>Pane 2</TabPane>
                </Panes>
            </TabContainer>);

        var content = cut.Find("div.tab-content");
    }

    [Fact]
    public void ActiveTabIdIsNotSet_FirstPaneIsSetToActive()
    {
        var cut = RenderComponent(
            @<TabContainer>
                <Panes>
                    <TabPane>Pane 1</TabPane>
                    <TabPane>Pane 2</TabPane>
                </Panes>
            </TabContainer>);

        AssertTabPane.IsActive(cut, ".tab-content .tab-pane:first-child");
        AssertTabPane.IsNotActive(cut, ".tab-content .tab-pane:nth-child(2)");
    }

    [Theory]
    [InlineData(TabId1)]
    [InlineData(TabId2)]
    [InlineData(TabId3)]
    public void ActiveTabIdIsSet_TabPaneWithActiveIsSetToActiveOnInitialRender(string activeTabId)
    {
        var cut = RenderComponent(
            @<TabContainer ActiveTabId="@activeTabId">
                <Panes>
                    <TabPane Id="@TabId1">Pane 1</TabPane>
                    <TabPane Id="@TabId2">Pane 2</TabPane>
                    <TabPane Id="@TabId3">Pane 3</TabPane>
                </Panes>
            </TabContainer>);

        AssertTabPane.IsActive(cut, $".tab-content .tab-pane#{activeTabId}");

        foreach(var tabPane in cut.FindAll($".tab-content .tab-pane:not(#{activeTabId})"))
        {
            AssertTabPane.IsNotActive(tabPane);
        }
    }

    [Theory]
    [InlineData(TabId1, TabId2)]
    [InlineData(TabId1, TabId3)]
    [InlineData(TabId2, TabId1)]
    public void ActiveTabIdIsUpdated_TabWithMatchingIdIsMadeActive(string initialActiveTab,
        string updatedActiveTab)
    {
        var cut = RenderComponent(
            @<TabContainer ActiveTabId="@initialActiveTab">
                <Panes>
                    <TabPane Id="@TabId1">Pane 1</TabPane>
                    <TabPane Id="@TabId2">Pane 2</TabPane>
                    <TabPane Id="@TabId3">Pane 3</TabPane>
                </Panes>
            </TabContainer>);

        cut.SetParametersAndRender(builder => builder.Add(x => x.ActiveTabId, updatedActiveTab));

        AssertTabPane.IsActive(cut, $".tab-content .tab-pane#{updatedActiveTab}");

        foreach (var tabPane in cut.FindAll($".tab-content .tab-pane:not(#{updatedActiveTab})"))
        {
            AssertTabPane.IsNotActive(tabPane);
        }
    }

    [Fact]
    public void TabsFragmentIsNotSet_RendersTabItemsForChildPanes()
    {
        
        var cut = RenderComponent(
            @<TabContainer>
                <Panes>
                    <TabPane Id="@TabId1" Title="@Title1">Pane 1</TabPane>
                    <TabPane Id="@TabId2" Title="@Title2">Pane 2</TabPane>
                    <TabPane Id="@TabId3" Title="@Title3">Pane 3</TabPane>
                </Panes>
            </TabContainer>);

        cut.Render();

        var tabItems = cut.FindAll("li");
        Assert.Equal(3, tabItems.Count);
        Assert.NotNull(cut.FindComponent<TabList>());
    }

    [Fact]
    public void TabsFragmentIsNotSet_ActiveTabIsChanged_CorrespondingTabItemMadeActive()
    {
        const int ActiveTabIndex = 2;

        var cut = RenderComponent(
            @<TabContainer>
                <Panes>
                    <TabPane Id="@TabId1" Title="@Title1">Pane 1</TabPane>
                    <TabPane Id="@TabId2" Title="@Title2">Pane 2</TabPane>
                    <TabPane Id="@TabId3" Title="@Title3">Pane 3</TabPane>
                </Panes>
            </TabContainer>);

        cut.Find($".nav-item:nth-child({ActiveTabIndex}) .nav-link")
            .Click();

        var tabPane = cut.FindComponents<TabItem>()[ActiveTabIndex - 1];

        Assert.True(tabPane.Instance.Active);
    }

    [Fact]
    public void TabsFragmentIsSet_RendersTabsFragment()
    {
        const string ExpectedContent = "unit test tabs";
        var cut = RenderComponent(
            @<TabContainer>
                <Tabs>@ExpectedContent</Tabs>
            </TabContainer>);

        Assert.Contains(ExpectedContent, cut.Markup);
    }

    [Fact]
    public void ContentIsSet_PanesIsNotSet_RendersContent()
    {
        const string ExpectedContent = "unit test tabs";
        var cut = RenderComponent(
            @<TabContainer>
                <Content>@ExpectedContent</Content>
            </TabContainer>);

        Assert.Contains(ExpectedContent, cut.Markup);
    }
}
